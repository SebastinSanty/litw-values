<!-- Template for instructions page -->

<h2 class="bolded-blue" data-i18n="litw-instruct-header"></h2>
	<p data-i18n="litw-instruct-body-1-p1"></p>
    <div class="col-5">
        <div id="convbox" class="container bg-light overflow-auto">
            <div id="intro">
                <div id="intro_snippet" class="col-8 robot-bg message-cloud p-2">
                    <div id="intro_message" data-i18n="study-convo-start"></div>
                    <div id="intro_sent" class="small_ai" data-i18n="study-convo-by_ai"></div>
                    <div id="intro_loading" class="lds-ellipsis lds-robot"><div></div><div></div><div></div><div></div></div>
                </div>
            </div>
            <div id="convo_thread"></div>
            <div id="bye">
                <div id="bye_snippet" class="col-8 robot-bg message-cloud p-2 hidden">
                    <div id="bye_message" data-i18n="study-convo-end"></div>
                    <div id="bye_sent" class="small_ai" data-i18n="study-convo-by_ai"></div>
                    <div id="bye_loading" class="lds-ellipsis lds-robot"><div></div><div></div><div></div><div></div></div>
                </div>
            </div>
        </div>
        <div id="typebox" class="container bg-light mb-3">
            <div class="row">
                <div class="col-12 rounded p-2">
                    <div class="rounded px-2 py-1" style="border:2px inset #AAA;">
                        <div id="snippettype"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="questions" class="gap-2 hidden">
            <button id="button_q1" type="button" class="btn btn-primary" onclick="question_chosen(1)">B1</button>
            <button id="button_q2" type="button" class="btn btn-primary" onclick="question_chosen(2)">B2</button>
        </div>
    </div>

<script>
    let convos = LITW.study.params.convo_snippets;
    $('#btn-next-page').attr('style', 'display:none;');
    let current_convo = 0;

    let show_message = function (msg_id, take_time=1500, callback) {
        return new Promise(function(resolve, reject) {
            $(`#${msg_id}_snippet`).show().delay(take_time/3).animate({opacity: 1}, take_time/10);
            $(`#${msg_id}_snippet`)[0].scrollIntoView();
            setTimeout(function () {
                $(`#${msg_id}_loading`).fadeOut(take_time/3, function () {
                    $(`#${msg_id}_message`).fadeIn(take_time/3);
                    $(`#${msg_id}_sent`).fadeIn(take_time/3);
                });
                callback();
            }, take_time);
        });
    };

    let add_convo = function (q_id, q_string, a_id, a_string) {
        $('#convo_thread').append(`<div id="${q_id}" class="pt-4"></div>`);
        $(`#${q_id}`).append(`<div id="${q_id}_snippet" class="col-8 human-bg message-cloud p-2 offset-4 hidden"></div>`);
        $(`#${q_id}_snippet`).append(`<div id="${q_id}_message" class="hidden">${q_string}</div>`);
        $(`#${q_id}_snippet`).append(`<div id="${q_id}_sent" class="small_human">${$.i18n('study-convo-by_you')}</div>`);
        $(`#${q_id}_snippet`).append(`<div id="${q_id}_loading" class="lds-ellipsis lds-human"><div></div><div></div><div></div><div></div></div>`);
        $('#convo_thread').append(`<div id="${a_id}" class="pt-4 pb-4"></div>`);
        $(`#${a_id}`).append(`<div id="${a_id}_snippet" class="col-8 robot-bg message-cloud p-2 hidden"></div>`);
        $(`#${a_id}_snippet`).append(`<div id="${a_id}_message" class="hidden">${a_string}</div>`);
        $(`#${a_id}_snippet`).append(`<div id="${a_id}_sent" class="small_ai">${$.i18n('study-convo-by_ai')}</div>`);
        $(`#${a_id}_snippet`).append(`<div id="${a_id}_loading" class="lds-ellipsis lds-robot"><div></div><div></div><div></div><div></div></div>`);
    }

    let req_question = function () {
        current_convo+=1;
        if(current_convo <= convos.length) {
            let q1 = convos[current_convo-1]['q1'];
            let q2 = convos[current_convo-1]['q2'];

            $('#button_q1').text(q1);
            $('#button_q2').text(q2);
            $('#questions').css('display', 'grid');
            $('#questions')[0].scrollIntoView();
        } else {
            show_message('bye', 1000, function (){
                //TODO: We need a new LITW.utils that only shows, but doesn't configure the next button!!!!
                $('#btn-next-page').attr('style', 'display:block;');
                $('#btn-next-page')[0].scrollIntoView();
            })
        }
    }

    let question_chosen = function( choice_num ) {
        add_convo(`q${current_convo}`, convos[current_convo-1][`q${choice_num}`],
                  `a${current_convo}`, convos[current_convo-1][`a${choice_num}`]);
        show_message(`q${current_convo}`, 1500, function (){
            $('#questions').hide();
        }).then( function () {
            setTimeout(function () {
                show_message(`a${current_convo}`, 1500, function (){
                    req_question();
                });
            }, 2000);
        }())
    }


    let ipromise = new Promise(function(resolve, reject) {
        let typing = new TypeIt("#snippettype", {
            startDelay: 5000,
            speed: 20,
            strings: $("messageq").value,
            afterComplete: function () {
                $("#loadingq").fadeOut(1500, function () {
                    $("#messageq").fadeIn(500);
                    $("#sentq").fadeIn(500);
                    $("#snippettype").animate({opacity: 0}, 300);
                    $('#snippeta').delay(3000).animate({opacity: 1}, 200);
                    setTimeout(function () {
                        $("#loadinga").fadeOut(500, function () {
                            $("#messagea").fadeIn(500);
                            $("#senta").fadeIn(500);
                            setTimeout(function () {
                                $("#nextbutton").fadeIn(100);
                            }, 2000);
                        });
                    }, 5000);
                });
            }
        }).go();
    });

    let convo_start = function (){
        show_message("intro", 1500, req_question);
    };

    convo_start();

</script>

